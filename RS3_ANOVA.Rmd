---
title: "2x2 repeated measures ANOVA with RS3 data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The following markdown analyses data from the RS3 in R. The results (main effects, interactions and folow up t-tests) are the same as JASP.

```{r load packages, results = 'hide', message = FALSE}
# rm(list = ls()) # clears environment

library(ggplot2) # plotting interaction plots
library(tidyr) # manipulating dataframes
library(dplyr) # manipulating dataframes
library(ez) # allows me to compute repeated ANOVA that matches JASP output
library(car) # allows me to use Anova() function to get summary of main effects and interactions
library(sjstats) # computes partial eta squared effect size
library(effsize) # computes cohen's D for follow up t-tests

```

Here I am loading the packages I'll need for the analysis. I put comment about why each one is needed. There are many ways to compute ANOVAs in R and there are many different packages you can use to do. However I have found the "ez" packages works best. I think explain down below. 

```{r loading in data as csv file}

# work computer working directory
setwd("C:/Users/pscmgo/OneDrive for Business/PhD/Project/Experiment_Code/teachingcode")

# load datset
temp = list.files(pattern = c("RS3_dataset", "*.csv")) # list all CSV files in the directory
myfiles = lapply(temp, read.csv) # read these CSV in the directory
workingdata <- do.call(rbind.data.frame, myfiles) # convert and combine the CSV files into dataframe

```

Here I am grabbing the data from my working directory

```{r descriptive statistics}

# Here I'm generating a participant ID, this will be important later
workingdata <- workingdata %>%
  mutate(ppid = row_number())

# computing histograms and normality curves for each condition
ggplot(workingdata %>%
         gather("NoAS_Ver", "NoAS_VerDemo", "AS_Ver", "AS_VerDemo", key = "condition", value = "correctpairs"), aes(x = correctpairs)) +
  geom_histogram(aes(y = ..density..)) +
  stat_function(
		fun = dnorm, 
		args = with(workingdata %>%
		              gather("NoAS_Ver", "NoAS_VerDemo", "AS_Ver", "AS_VerDemo", key = "condition", value = "correctpairs"), c(mean = mean(correctpairs), sd = sd(correctpairs)))) + 
  facet_wrap( ~ condition)

# descriptives for age
range(workingdata$Age)
mean(workingdata$Age)
sd(workingdata$Age)

```

Firstly I'm creating a new variable "ppid" to indicate the participant number. This will be important when the ANOVA in R attempts to calculate the degrees of freedom. 

Histograms are plotted with normal distributions to show how the data is distributed. In this case, things seem fairly normally distributed.

```{r manipulating dataframe}

# spliting conditions into factors and their levels
split_data <- workingdata %>%
  gather("NoAS_Ver", "NoAS_VerDemo", "AS_Ver", "AS_VerDemo", key = "condition", value = "correctpairs") %>%
  separate(condition, into = c("task", "presentation"))

head(split_data, n = 5)
tail(split_data, n = 5)

# sets our factors as a factor data types
split_data$task <- as.factor(split_data$task)
split_data$presentation <- as.factor(split_data$presentation)
split_data$ppid <- as.factor(split_data$ppid)

```

In JASP, each column represents a condition. In R, I need the columns to refer to the different factors, with each row being an observation. Hence I use the gather function to create a condition and value column. I then use the separate function to seperate the conditions into "task" and "presentation". The head and tail function demonstrate what this data frame looks like now.

I then ensure the factors in this design are set to the factor data types.

```{r running the ANOVA the WRONG way}

# running the ANOVA this way generates the wrong f values and sums of squares
result_wrong <- aov(correctpairs ~ task * presentation, data = split_data)
Anova(result_wrong, type = 3)

```

This is how I first tried to run the ANOVA. However as you can see, the sum of squares, f values and degrees of freedom (DF) are wrong (despite using type 3 sum of squares like JASP). After many nights of searching, i realised the problem is the DFs.

```{r number of rows = DFs}
nrow(split_data)
```

The DFs are the number of observations that are allowed to vary in the statistical calculation calculated as the N - 1. However because we have arranged the dataframe so that each column is a factor, our dataframe is telling the ANOVA that we 1780 observations. We actually have 445 (the number of participants).

```{r running the ANOVA the RIGHT way}

# running the ANOVA this way generates the correc f values and sum of sqaures
result_correct <- ezANOVA(split_data, dv = correctpairs, wid = ppid, within = .(task, presentation), type = 3, detailed = TRUE, return_aov = TRUE)
result_correct

# effect sizes for the correct ANOVA method
eta_sq(result$aov, partial = TRUE)

```

If we use the ezANOVA function, we can specify the number of cases we actually have with the "wid" arugument. We assign this the ppid variable made earlier. This means that the DFs can be correctly calculated, and now the sum of squares (SSn), F value and DFs match the JASP output.



```{r interaction plot}

ggplot(data = split_data, aes(x = presentation, color = task, group = task, y = correctpairs)) +
         stat_summary(fun.y = mean, geom = "point") +
         stat_summary(fun.y = mean, geom = "line")

```

Interaction plot visualises interaction i.e. a difference in differences.

```{r exploring main effect and interaction}

model.tables(result$aov, "mean", se = TRUE)

# TukeyHSD(standard.two.aov)

t.test(workingdata$NoAS_Ver, workingdata$AS_Ver, paired = TRUE)
cohen.d(workingdata$NoAS_Ver, workingdata$AS_Ver)

```

model.tables function computes estimated marginal means for levels wihtin each main effect (they match to SPSS and JASP output). Hence this helps understand the significnat main effects

TukeyHSD function compute post hoc analyses to understand the interaction. Of note are the following comparisons:

**NoAS:Ver-AS:Ver**, **NoAS:VerDemo-AS:VerDemo**

These demonstrate the same mean differences as the two paired samples t-tests in the SPSS output. Hence this is the equivalent in R form. Only problem now is computing effect sizes for the Tukey post hoc analyses.


```{r means and anova with table output in word document}

# apa table ANOVA
# setwd("C:/Users/pscmgo/OneDrive for Business/PhD/Project/Experiment_Code/teachingcode")
# apa.1way.table(condition, correctpairs, workingdata, filename = "RS3_seminar.doc", show.conf.interval = TRUE, landscape = TRUE)

```