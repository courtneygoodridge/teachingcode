---
title: "2x2 repeated measures ANOVA with RS3 data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The following markdown analyses data from the RS3 in R. The results (main effects, interactions and folow up t-tests) are the same as JASP.

```{r load packages, results = 'hide', message = FALSE}
# rm(list = ls()) # clears environment

library(ggplot2) # plotting interaction plots
library(tidyr) # manipulating dataframes
library(dplyr) # manipulating dataframes
library(sjstats) # computes partial eta squared effect size
library(ez) # allows me to compute repeated ANOVA that matches JASP output

```

Here I am loading the packages I'll need for the following analyses. I have commented why each one i necessary. There are loads of ways to compute ANOVAs in R and there are many different packages, but these worked for this analysis

```{r loading in data as csv file}

# work computer working directory
setwd("C:/Users/pscmgo/OneDrive for Business/PhD/Project/Experiment_Code/teachingcode")

# load datset
temp = list.files(pattern = c("RS3_dataset", "*.csv")) # list all CSV files in the directory
myfiles = lapply(temp, read.csv) # read these CSV in the directory
workingdata <- do.call(rbind.data.frame, myfiles) # convert and combine the CSV files into dataframe

```

Here I am

```{r demographics, normality mean scores and reshaping data}

workingdata <- workingdata %>%
  mutate(ppid = row_number())

# computing histograms and normality curves for each condition
ggplot(workingdata %>%
         gather("NoAS_Ver", "NoAS_VerDemo", "AS_Ver", "AS_VerDemo", key = "condition", value = "correctpairs"), aes(x = correctpairs)) +
  geom_histogram(aes(y = ..density..)) +
  stat_function(
		fun = dnorm, 
		args = with(workingdata %>%
		              gather("NoAS_Ver", "NoAS_VerDemo", "AS_Ver", "AS_VerDemo", key = "condition", value = "correctpairs"), c(mean = mean(correctpairs), sd = sd(correctpairs)))) + 
  facet_wrap( ~ condition)

# spliting conditions into factors and their levels
split_data <- workingdata %>%
  gather("NoAS_Ver", "NoAS_VerDemo", "AS_Ver", "AS_VerDemo", key = "condition", value = "correctpairs") %>%
  separate(condition, into = c("task", "presentation"))

# age demographics
range(split_data$Age)
mean(split_data$Age)
sd(split_data$Age)

# mean scores for condition
split_data %>%
  group_by(task, presentation) %>%
  summarise(mean_corrected_pairs = mean(correctpairs))

```

Histograms show that data seems fairly normally distributed for each condition. Mean values for each condition show differences. 

```{r performing two-way anova}

# sets our factors as a factor data types
split_data$task <- as.factor(split_data$task)
split_data$presentation <- as.factor(split_data$presentation)

library(ez)
result <- ezANOVA(split_data, dv = correctpairs, wid = ppid, within = .(task, presentation), type = 3, detailed = TRUE, return_aov = TRUE)

library(sjstats)
eta_sq(result$aov, partial = TRUE)

# TukeyHSD(result$aov)

```

This repeated measures ANOVA in R sums of squares, mean square and eta squared values that are the same as SPSS and JASP. However the f value is different and I cannot understand why.

Type 1 sum of squares performs analyses sequentially i.e. how they appears within the model that you specify.

Type 3 sum of squares performs analyses in light of other main effects and interactions.

The distinction is important, because the sometimes a main effect can be generated BECAUSE of the an interaction (i.e. one factor level has a low average because of the interaction). Thus is you use type 1 or 3 in this instance, you are likely to get different results.

**TO DO**

- ASK ON STATS EXCHANGE: Why am I getting values that match JASP on everything except for my f value?
- Understand why "options(contrasts = c("contr.sum", "contr.poly"))" works (check previously sent material on email) 
- Compute interaction plots for ANOVA **done**
- Compute estimated margin means for main effects **done**
- Compute paired samples t test for investigating interaction **done**
- Check values for all these tests match JASP/SPSS
- Check how to compute effect sizes for Tukey post hoc analyses
- Ask forum how to get correct degrees of freedom (444) but still be able to perform ANOVA (it is the difference in degrees of freedom that it making my F values differ!) **done**

```{r interaction plot}

ggplot(data = split_data, aes(x = presentation, color = task, group = task, y = correctpairs)) +
         stat_summary(fun.y = mean, geom = "point") +
         stat_summary(fun.y = mean, geom = "line")

```

Interaction plot visualises interaction i.e. a difference in differences.

```{r exploring main effect and interaction}

model.tables(result$aov, "mean", se = TRUE)

# TukeyHSD(standard.two.aov)

t.test(workingdata$NoAS_Ver, workingdata$AS_Ver, paired = TRUE)
cohen.d(workingdata$NoAS_Ver, workingdata$AS_Ver)

```

model.tables function computes estimated marginal means for levels wihtin each main effect (they match to SPSS and JASP output). Hence this helps understand the significnat main effects

TukeyHSD function compute post hoc analyses to understand the interaction. Of note are the following comparisons:

**NoAS:Ver-AS:Ver**, **NoAS:VerDemo-AS:VerDemo**

These demonstrate the same mean differences as the two paired samples t-tests in the SPSS output. Hence this is the equivalent in R form. Only problem now is computing effect sizes for the Tukey post hoc analyses.


```{r means and anova with table output in word document}

# apa table ANOVA
# setwd("C:/Users/pscmgo/OneDrive for Business/PhD/Project/Experiment_Code/teachingcode")
# apa.1way.table(condition, correctpairs, workingdata, filename = "RS3_seminar.doc", show.conf.interval = TRUE, landscape = TRUE)

```